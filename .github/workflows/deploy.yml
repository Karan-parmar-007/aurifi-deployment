name: Full Stack Deployment

on:
  push:
    branches: [ master, main ]

jobs:
  full-deployment:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Full Stack Deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        script: |
          cd /opt/aurifi
          
          echo "ğŸš€ Starting Full Stack Deployment from deployment repo..."
          echo "âš ï¸  This will completely refresh both frontend and backend"
          
          # Update deployment files from git
          echo "ğŸ“¦ Updating deployment configuration..."
          git pull origin main || git pull origin master
          
          echo "ğŸ›‘ Stopping all services..."
          docker compose down --remove-orphans
          
          echo "ğŸ§¹ Removing old containers and images..."
          docker container prune -f
          docker image prune -a -f
          
          echo "ğŸ“¥ Pulling latest images..."
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/aurifi-frontend:latest
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/aurifi-backend:latest
          docker pull nginx:alpine
          
          echo "ğŸ”¨ Starting fresh deployment..."
          docker compose up -d
          
          echo "â³ Waiting for services to initialize..."
          sleep 30
          
          echo "ğŸ“Š Service status:"
          docker compose ps
          
          echo "ğŸ” Running health checks..."
          
          # Wait for services to be ready
          echo "Waiting for frontend..."
          for i in {1..30}; do
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "âœ… Frontend is ready"
              break
            fi
            echo -n "."
            sleep 2
          done
          
          echo "Waiting for backend..."
          for i in {1..30}; do
            if curl -f http://localhost:5000/api/v1/user/ > /dev/null 2>&1; then
              echo "âœ… Backend is ready"
              break
            fi
            echo -n "."
            sleep 2
          done
          
          echo "Waiting for nginx..."
          for i in {1..20}; do
            if curl -f http://localhost > /dev/null 2>&1; then
              echo "âœ… Nginx is ready"
              break
            fi
            echo -n "."
            sleep 2
          done
          
          echo ""
          echo "ğŸ” Final connectivity tests:"
          
          # Test frontend via nginx
          if curl -I http://localhost/ > /dev/null 2>&1; then
            echo "âœ… Frontend accessible via nginx"
          else
            echo "âŒ Frontend test failed"
          fi
          
          # Test backend API via nginx
          if curl -I http://localhost/api/v1/user/ > /dev/null 2>&1; then
            echo "âœ… Backend API accessible via nginx"
          else
            echo "âŒ Backend API test failed"
          fi
          
          echo ""
          echo "ğŸ“‹ Final service status:"
          docker compose ps
          
          echo ""
          echo "ğŸ“Š Container resource usage:"
          docker stats --no-stream
          
          echo ""
          echo "ğŸ‰ Full stack deployment completed!"
          echo "ğŸŒ Frontend: http://165.22.214.208"
          echo "ğŸ”— Backend API: http://165.22.214.208/api/v1"
          echo "ğŸ“… Deployed at: $(date)"